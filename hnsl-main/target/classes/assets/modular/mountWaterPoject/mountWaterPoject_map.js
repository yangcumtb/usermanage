var iconColor = ["#0ca5e2", "#38d5d0", "#f6c52b", "#F77147"];
var pickerData = [];
var _location = [114.39548492431642, 37.08359831045062];
var searchFeatures = {
    "type": "FeatureCollection",
    "features": [
        {
            "type": "Feature",
            "properties": {
                "adcode": 210100,
                "name": "生产矿山1",
                "center": [
                    41.796767,
                    123.429096
                ],
                "centroid": [
                    42.100641,
                    123.143796
                ],
                "childrenNum": 13,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 0,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.43428607690261,
                            119.49419432349008
                        ],
                        [
                            41.4323052725957,
                            119.49420971932524
                        ],
                        [
                            41.43232098704317,
                            119.49779886226256
                        ],
                        [
                            41.434301803058695,
                            119.49778357164652
                        ],
                        [
                            41.43428607690261,
                            119.49419432349008
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 210200,
                "name": "建设项目1",
                "center": [
                    38.91459,
                    121.618622
                ],
                "centroid": [
                    39.593378,
                    122.190893
                ],
                "childrenNum": 10,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 1,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "MultiPolygon",
                "coordinates": [
                    [
                        [
                            [
                                41.42461888779221,
                                119.48673282761486
                            ],
                            [
                                41.41597533394228,
                                119.48680094524939
                            ],
                            [
                                41.41601540215173,
                                119.49589118966693
                            ],
                            [
                                41.42465895080342,
                                119.49582429151289
                            ],
                            [
                                41.42461888779221,
                                119.48673282761486
                            ]
                        ]
                    ],
                    [
                        [
                            [
                                41.43450690239331,
                                119.48306547290373
                            ],
                            [
                                41.429464815720294,
                                119.48310553869615
                            ],
                            [
                                41.429484092647904,
                                119.48741229313492
                            ],
                            [
                                41.43452616139042,
                                119.4873725816773
                            ],
                            [
                                41.43450690239331,
                                119.48306547290373
                            ]
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 210300,
                "name": "建设项目2",
                "center": [
                    41.110626,
                    122.995632
                ],
                "centroid": [
                    40.718251,
                    123.016394
                ],
                "childrenNum": 7,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 2,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "MultiPolygon",
                "coordinates": [
                    [
                        [
                            [
                                41.530188000775695,
                                119.53944168528562
                            ],
                            [
                                41.52478584878793,
                                119.53948000359935
                            ],
                            [
                                41.5248238793186,
                                119.5490647468406
                            ],
                            [
                                41.53022604209821,
                                119.5490272226283
                            ],
                            [
                                41.530188000775695,
                                119.53944168528562
                            ]
                        ]
                    ],
                    [
                        [
                            [
                                41.56247621270711,
                                119.50908604268682
                            ],
                            [
                                41.55707404363227,
                                119.50912696004127
                            ],
                            [
                                41.55710017613228,
                                119.51527619144315
                            ],
                            [
                                41.56250236229425,
                                119.51523580199068
                            ],
                            [
                                41.56247621270711,
                                119.50908604268682
                            ]
                        ]
                    ],
                    [
                        [
                            [
                                41.56546058593733,
                                119.47145460864328
                            ],
                            [
                                41.561859214830974,
                                119.4714839769041
                            ],
                            [
                                41.56132066121961,
                                119.4718480071798
                            ],
                            [
                                41.55825950207441,
                                119.47187295887
                            ],
                            [
                                41.558273779711215,
                                119.47498958729966
                            ],
                            [
                                41.561334954144854,
                                119.47496477680306
                            ],
                            [
                                41.56187296006908,
                                119.47448089567683
                            ],
                            [
                                41.5654765228233,
                                119.47493121320497
                            ],
                            [
                                41.56546058593733,
                                119.47145460864328
                            ]
                        ]
                    ],
                    [
                        [
                            [
                                41.54179810359966,
                                119.51634927330042
                            ],
                            [
                                41.53782996378186,
                                119.514820989697
                            ],
                            [
                                41.537299844911956,
                                119.51722165435592
                            ],
                            [
                                41.54126795415283,
                                119.51875009983735
                            ],
                            [
                                41.54179810359966,
                                119.51634927330042
                            ]
                        ]
                    ],
                    [
                        [
                            [
                                41.53667512995332,
                                119.51854449503253
                            ],
                            [
                                41.534514271316596,
                                119.51856050476351
                            ],
                            [
                                41.53452329691265,
                                119.52071739199414
                            ],
                            [
                                41.53668415285142,
                                119.52070143622234
                            ],
                            [
                                41.53667512995332,
                                119.51854449503253
                            ]
                        ]
                    ],
                    [
                        [
                            [
                                41.54602675543049,
                                119.51559866134926
                            ],
                            [
                                41.54449614977756,
                                119.51561007374596
                            ],
                            [
                                41.544503712176606,
                                119.51740774297298
                            ],
                            [
                                41.54603431513158,
                                119.5173963719451
                            ],
                            [
                                41.54602675543049,
                                119.51559866134926
                            ]
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 210400,
                "name": "生产矿山3",
                "center": [
                    41.875956,
                    123.921109
                ],
                "centroid": [
                    41.837685,
                    124.662356
                ],
                "childrenNum": 7,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 3,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.54346233266527,
                            119.75229542359295
                        ],
                        [
                            41.53932058072599,
                            119.7523112354427
                        ],
                        [
                            41.53933333578779,
                            119.75830315673497
                        ],
                        [
                            41.53519158033856,
                            119.75831858388065
                        ],
                        [
                            41.53520031848429,
                            119.76251265090704
                        ],
                        [
                            41.543483821162425,
                            119.76248234169353
                        ],
                        [
                            41.54346233266527,
                            119.75229542359295
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 210500,
                "name": "废弃矿山3",
                "center": [
                    41.297909,
                    123.770519
                ],
                "centroid": [
                    41.231499,
                    124.574237
                ],
                "childrenNum": 6,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 4,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.50603902144776,
                            119.60323420245554
                        ],
                        [
                            41.50539520359693,
                            119.60228327410972
                        ],
                        [
                            41.50352878329958,
                            119.60165630051834
                        ],
                        [
                            41.497660452352356,
                            119.60168979441531
                        ],
                        [
                            41.49768346540282,
                            119.60839637822617
                        ],
                        [
                            41.506056898378006,
                            119.60834589988875
                        ],
                        [
                            41.50603902144776,
                            119.60323420245554
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 210600,
                "name": "自然灾损1",
                "center": [
                    40.124296,
                    124.383044
                ],
                "centroid": [
                    40.544775,
                    124.40518
                ],
                "childrenNum": 6,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 5,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.514339880288375,
                            119.63632825954048
                        ],
                        [
                            41.506072924163036,
                            119.64164481222777
                        ],
                        [
                            41.506081117032146,
                            119.6442799118662
                        ],
                        [
                            41.510084844773985,
                            119.64329968478778
                        ],
                        [
                            41.510079266518716,
                            119.64150293021764
                        ],
                        [
                            41.51264533994126,
                            119.64148875026305
                        ],
                        [
                            41.51434742883282,
                            119.63872409542003
                        ],
                        [
                            41.514339880288375,
                            119.63632825954048
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 210700,
                "name": "测试",
                "center": [
                    41.119269,
                    121.135742
                ],
                "centroid": [
                    41.461822,
                    121.618541
                ],
                "childrenNum": 7,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 6,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.385681382109055,
                            119.66932696631889
                        ],
                        [
                            41.384962765427645,
                            119.66992839460842
                        ],
                        [
                            41.3865920364729,
                            119.67290912712238
                        ],
                        [
                            41.38749075275693,
                            119.67230680184653
                        ],
                        [
                            41.385681382109055,
                            119.66932696631889
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 210800,
                "name": "自然灾损2",
                "center": [
                    40.667432,
                    122.235151
                ],
                "centroid": [
                    40.391795,
                    122.456202
                ],
                "childrenNum": 6,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 7,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.577930437275235,
                            119.67499003605761
                        ],
                        [
                            41.576868006999575,
                            119.67499536737341
                        ],
                        [
                            41.57686209440611,
                            119.66666170511701
                        ],
                        [
                            41.56847054222974,
                            119.66665685094584
                        ],
                        [
                            41.56852897770551,
                            119.68749396138519
                        ],
                        [
                            41.57686656807929,
                            119.68748973781673
                        ],
                        [
                            41.576861721092094,
                            119.67915620562793
                        ],
                        [
                            41.57794212838253,
                            119.67913886668518
                        ],
                        [
                            41.577930437275235,
                            119.67499003605761
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 210900,
                "name": "废弃矿山1",
                "center": [
                    42.011796,
                    121.648962
                ],
                "centroid": [
                    42.282968,
                    121.961888
                ],
                "childrenNum": 7,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 8,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.59053048840961,
                            119.67212075421082
                        ],
                        [
                            41.58827956710512,
                            119.6721321856353
                        ],
                        [
                            41.58828913242545,
                            119.67549020979759
                        ],
                        [
                            41.590540053705396,
                            119.67547887098947
                        ],
                        [
                            41.59053048840961,
                            119.67212075421082
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 211000,
                "name": "废弃矿山2",
                "center": [
                    41.269402,
                    123.18152
                ],
                "centroid": [
                    41.184819,
                    123.251133
                ],
                "childrenNum": 7,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 9,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.56926652084845,
                            119.63721892704805
                        ],
                        [
                            41.565661250675014,
                            119.63604023366226
                        ],
                        [
                            41.56566882575997,
                            119.63843796598157
                        ],
                        [
                            41.569277820480615,
                            119.64081573635814
                        ],
                        [
                            41.56926652084845,
                            119.63721892704805
                        ]
                    ]
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "adcode": 211100,
                "name": "废弃矿山3",
                "center": [
                    41.124484,
                    122.06957
                ],
                "centroid": [
                    41.06851,
                    121.999309
                ],
                "childrenNum": 4,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 10,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.59274136144829,
                            119.65837651155184
                        ],
                        [
                            41.58913988988537,
                            119.65839554110725
                        ],
                        [
                            41.585247593352825,
                            119.6666910132476
                        ],
                        [
                            41.581075952251524,
                            119.6719289995338
                        ],
                        [
                            41.58108467015739,
                            119.6749868401889
                        ],
                        [
                            41.58518132728938,
                            119.67496619108941
                        ],
                        [
                            41.585169539733016,
                            119.67082884617115
                        ],
                        [
                            41.58935624672873,
                            119.67080746024445
                        ],
                        [
                            41.589331830781205,
                            119.66241228847937
                        ],
                        [
                            41.59275325394684,
                            119.66239438579689
                        ],
                        [
                            41.59274136144829,
                            119.65837651155184
                        ]
                    ]
                ]
            }
        },

        {
            "type": "Feature",
            "properties": {
                "adcode": 211400,
                "name": "建设项目6",
                "center": [
                    40.755572,
                    120.856394
                ],
                "centroid": [
                    40.620597,
                    120.21031
                ],
                "childrenNum": 6,
                "level": "city",
                "parent": {
                    "adcode": 210000
                },
                "subFeatureIndex": 13,
                "acroutes": [
                    100000,
                    210000
                ]
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            41.47385175275622,
                            119.53529138239139
                        ],
                        [
                            41.471662331651316,
                            119.53270923004698
                        ],
                        [
                            41.46953741801747,
                            119.53271250807586
                        ],
                        [
                            41.46885727604251,
                            119.53596152390526
                        ],
                        [
                            41.47087763269667,
                            119.53682100778337
                        ],
                        [
                            41.473397167045675,
                            119.53643194128108
                        ],
                        [
                            41.47385175275622,
                            119.53529138239139
                        ]
                    ]
                ]
            }
        }
    ]
};
var token = null;

var admin = null;


document.addEventListener("message", function (msg) {
    var obj = JSON.parse(msg.data);
    token = obj.token;
    _location = [obj.lat, obj.lng];

});
var lng = document.getElementById('lng');
var lat = document.getElementById('lat');
L.Control.MousePosition = L.Control.extend({
    options: {
        position: 'bottomleft',
        separator: ':',
        emptyString: '经纬度坐标',
        lngFirst: false,
        numDigits: 8,
        lngFormatter: undefined,
        latFormatter: undefined,
        prefix: ""
    },

    onAdd: function (map) {
        this._container = L.DomUtil.create('div', 'leaflet-control-mouseposition');
        L.DomEvent.disableClickPropagation(this._container);
        map.on('mousemove', this._onMouseMove, this);
        this._container.innerHTML = this.options.emptyString;
        return this._container;
    },

    onRemove: function (map) {
        map.off('mousemove', this._onMouseMove)
    },

    _onMouseMove: function (e) {
        lng = this.options.lngFormatter ? this.options.lngFormatter(e.latlng.lng) : L.Util.formatNum(e.latlng.lng, this.options.numDigits);
        lat = this.options.latFormatter ? this.options.latFormatter(e.latlng.lat) : L.Util.formatNum(e.latlng.lat, this.options.numDigits);
        var value = this.options.lngFirst ? lng + this.options.separator + lat : lat + this.options.separator + lng;
        var prefixAndValue = this.options.prefix + ' ' + value;
        this._container.innerHTML = prefixAndValue;
    }

});

L.Map.mergeOptions({
    positionControl: false
});

L.Map.addInitHook(function () {
    if (this.options.positionControl) {
        this.positionControl = new L.Control.MousePosition();
        this.addControl(this.positionControl);
    }
});

L.control.mousePosition = function (options) {
    return new L.Control.MousePosition(options);
};
layui.config({
    cacheTab: false,
    base: Feng.ctxPath +  '/assets/common/module/'
}).extend({
    // dropdown: 'dropdown/dropdown',
}).use(['layer', 'element', 'admin', 'util','form', 'HttpRequest', 'tree','xmSelect'], function () {
    var util = layui.util;
    var HttpRequest = layui.HttpRequest;
    var element = layui.element;
    var gisMap;
    var $ = layui.jquery;
    var  admin = layui.admin;
    var tree = layui.tree;
    var $ = layui.jquery;
    var xmSelect = layui.xmSelect;
    var form = layui.form;
    var xmqy = xmSelect.render({
        el: '#xmqy',
        theme: {
            color: '#8799a3',
        },
        autoRow: true,
        data: [
            {name: '沈阳', value: 1,selected:false},
            {name: '大连', value: 2,selected:false},
            {name: '鞍山', value: 3,selected:false},
            {name: '抚顺', value: 4,selected:false},
            {name: '本溪', value: 5,selected:false},
            {name: '丹东', value: 6,selected:false},
            {name: '锦州', value: 7,selected:false},
            {name: '营口', value: 8,selected:false},
            {name: '阜新', value: 9,selected:false},
            {name: '辽阳', value: 10,selected:false},
            {name: '盘锦', value: 11,selected:false},
            {name: '铁岭', value: 12,selected:false},
            {name: '朝阳', value: 13,selected:false},
            {name: '葫芦岛', value: 14,selected:false},
        ],
    });
    //单击事件
    $("#cancel").click(function (){
        $("#massagecard").css('display','none');
    })
    function ClickToCard (data) {
        console.log(data);
        var Data = data.target.feature;
        $("#massagecard").css('display','');
        $("#id").attr("value",Data.id);
        $("#xmmc").attr("value",Data.name);
        $("#jd").attr("value",Data.geometry.coordinates[0]);
        $("#wd").attr("value",Data.geometry.coordinates[1]);
        $("#nr").text(Data.content);
    };
    //查询
    form.on('submit(searchBtn)', function (data) {
        data.field.xzs = xmqy.getValue('nameStr');
        var ajax = new HttpRequest(Feng.ctxPath + "/mountwaterCommon/searchproject", 'post', function (data) {

        }, function (data) {
            Feng.error("查询失败！" + data.message)
        });
        ajax.set(data.field);
        var result = ajax.start();
        console.log(result)
        if ( result.data == "查询到0条数据！") {
            Feng.error("没有数据")
        } else {
            Feng.success("查询成功！");
            $("#search-list").empty();
            for (var i = 0; i < result.data.length; i++) {
                var featureTemp = result.data[i];
                var resultDome = "<ul class=\"mui-table-view\"><li class=\"mui-table-view-cell mui-media zoomFeature\" data-geojson=\"geojsonvalue\"><a></a><div class=\"mui-media-body search-title\" style='font-size: 4px'>测试地块</div></li></ul>";
                resultDome = resultDome.replace("测试地块", featureTemp.gcxmmc);
                var $resultDom = $(resultDome);
                $resultDom.appendTo($("#search-list"));
                $("#searchNum").text(result.data.length);
                element.tabChange('demo', '2');
            }
            var pointFeature = [];
            for (i = 0; i < result.data.length; i++) {
                var Obj = new Object();
                Obj.type = "Feature";
                Obj.properties = {
                    "name": "Coors Field",
                    "amenity": "Baseball Stadium",
                    "popupContent": "辽宁省"
                };
                Obj.id = result.data[i].id;
                Obj.name = result.data[i].gcxmmc;
                Obj.content = result.data[i].zygznr;
                Obj.geometry = {
                    "type": "Point",
                    "coordinates": [result.data[i].jd,result.data[i].wd]
                }
                pointFeature.push(Obj);
            };
            L.geoJSON(pointFeature, {
                onEachFeature: onEachFeature
            }).addTo(gisMap);
            function onEachFeature(feature, layer) {
                layer.on({
                    click: ClickToCard
                });
            }
            $("#search-list").on("click", "li", function (event) {
                console.log(event)
                var id = event.currentTarget.lastElementChild.firstChild.data;
                for ( i = 0; i <result.data.length; i++) {
                    var project = result.data[i];
                    if ( project.gcxmmc == id) {
                        var position = [project.wd,project.jd];
                        gisMap.flyTo(position,15);
                    }
                }
            });
        }
        return false;
    });
    //var ajax = new HttpRequest(Feng.ctxPath + "/spot/lsyl/location?id=" + Feng.getUrlParam("id"), "get");
    //var result = ajax.start();
    //var wkt = "POINT(120.15554295191536 41.794033808982036)";
    //if(result.data.geoJSONBeforeRepair == null){
     //   parent.layer.closeAll();
     //   parent.layer.msg('没有图斑空间数据', {time: 3000});
    //}
    //var geojson = Terraformer.WKT.parse(wkt);


    //var bounds = geojson.bbox();
    //gisMap.fitBounds([ [bounds[1], bounds[0]], [bounds[3], bounds[2]] ]);

    function onEachFeature(feature, layer,innerHTML) {
        var popupContent = '<table class="table" >' +
            '<tr>' +
            '<th rowspan="1">图斑类型</th>' +
            '<td>历史遗留矿山</td>' +
            '</tr>' +
            '<th rowspan="1">图斑编号：</th>' +
            '<td>' +  +
            '</td>' +
            '<tr>' +
            '<th rowspan="1">所在市：</th>' +
            '<td>' +  +
            '</td>' +
            '<tr>' +
            '<th rowspan="1">所在县：</th>' +
            '<td>' +  +
            '</td>' +
            '<tr>' +
            '<th rowspan="1">图斑面积：</th>' +
            '<td>' +  +
            '</td>' +
            '<tr>' +
            '<th rowspan="1">中心点经度：</th>' +
            '<td>' +  +
            '</td>' +
            '<tr>' +
            '<th rowspan="1">中心点纬度：</th>' +
            '<td>' +  +
            '</td>' +
            '<tr>' +
            '<th rowspan="1">图斑属性：</th>' +
            '<td>露天矿厂</td>' +
            '<tr>' +
            '<th rowspan="1">三调地类：</th>' +
            '<td>' +  +
            '</td>' +
            '<tr>' +
            '<th rowspan="1">拟修复时间：</th>' +
            '<td>' +  +
            '</td>' +
            '<tr>' +
            '<th rowspan="1">核查具体日期：</th>' +
            '<td>' +  +
            '</td>' +
            '<tr>' +
            '<th rowspan="1">责任主体：</th>' +
            '<td>' + +
            '</td>' +
            '</tr>' +
            '</table>' +''
        layer.bindPopup(popupContent);

    }








    //打开图层选择器
    $("#layerSelBtn").click(function () {

        $(".filterShow").css("display", "none");
        $(".layerShow").css("display", "block");

        // 打开右侧面板
        admin.popupRight({
            type: 1,
            content: $('#layer-content')
        });

    })

    //打开筛选面板
    $("#layerFilterBtn").click(function () {
        $(".filterShow").css("display", "block");
        $(".layerShow").css("display", "none");

        // 打开右侧面板
        admin.popupRight({
            type: 1,
            content: $('#layer-content')
        });

    });

    $("#dropdown-menu-nav").on("click", "li", function () {
        $(".filter-group.show").removeClass("show").addClass("hide");
        $("#" + $(this).attr("data-layer") + "_filter").addClass("show").removeClass("hide");
        $(".active-layer").text($(this).text());

        $(".dropdown-menu").removeClass("dropdown-open");
    });


    $(".filter-item").click(function () {
        $(this).siblings().removeClass("active");
        $(this).addClass("active");
    });

    /*右侧筛选按钮*/
    $("#filterBtn").click(function () {
        var params = {};
        var layerId = null;
        $(".filter-group.show li.active").each(function () {
            var code = $(this).attr("data-type");
            var value = $(this).attr("data-value");
            if (layerId == null) {
                layerId = $(this).attr("data-layer");
            }
            if (value != -1) {
                params[code] = value;
            }
        });

        if (gisMap.findLayerById(layerId) == null) {
            mui.toast("请先加载图层");
            return;
        }

        var layerConfig = layers[layerId];
        gisMap.remove(layerConfig.layer);
        searchFeatures[layerId] = [];
        drawLayer(layerId, params);


        gisMap.on('mousemove', (e) => {
            let latlng = e.latlng;
            $("#lng").text(latlng.lng.toFixed(8));
            $("#lat").text(latlng.lat.toFixed(8));
        });
    });


    // $("#modal-close").click(function () {
    //     document.querySelector(".mui-modal").classList.remove("mui-active");


    function initMap() {
        var normalm = L.tileLayer.chinaProvider('GaoDe.Normal.Map', {
            maxZoom: 18,
            minZoom: 1
        });
        var imgm = L.tileLayer.chinaProvider('GaoDe.Satellite.Map', {
            maxZoom: 18,
            minZoom: 1
        });
        var imga = L.tileLayer.chinaProvider('GaoDe.Satellite.Annotion', {
            maxZoom: 18,
            minZoom: 1
        });

        // var url = "http://47.98.228.1:20000/geoserver/gwc/service/wmts";
        // var spotImage = "spot:10";
        // var spotImageLayer = new L.TileLayer.WMTS(url,
        //     {
        //         layer: spotImage,
        //         tilematrixSet: "EPSG:900913",
        //         format: "image/png",
        //     }
        // );
        var normalLayer = L.layerGroup([normalm]);
        var imageLayer = L.layerGroup([imgm, imga]);
        //var cor1 = L.latLng(45.30462108, 112.03515625);
        //var cor2 = L.latLng(38.80251791, 133.34472656);
        //var bounds = L.latLngBounds(cor1, cor2); //构建视图限制范围
        gisMap = new L.map('mapDiv',
            {
                zoom:7,
                center: [41.02, 126.37],
                layers: [imageLayer],
                zoomControl: false,
                attributionControl: false,
                //maxBounds: bounds,
                minZoom: 5,
                maxZoom: 18,
            });
        //gisMap.on('click', onMapClick);
        gisMap.on('mousemove', (e) => {
            let latlng = e.latlng;
            $("#lng").text(latlng.lng.toFixed(8));
            $("#lat").text(latlng.lat.toFixed(8));
        });
        // 针对每个要素采取的操作,以下为test死数据
        // function onEachFeature(feature, layer) {
        //     layer.on({
        //         click: ClickToCard
        //     });
        //     console.log(feature)
        // }
        // var geojsonFeature = [{
        //     "type": "Feature",
        //     "name": "test",
        //     "id": "1",
        //     "content": "test",
        //     "properties": {
        //         "name": "Coors Field",
        //         "amenity": "Baseball Stadium",
        //         "popupContent": "辽宁省"
        //     },
        //     "geometry": {
        //         "type": "Point",
        //         "coordinates": [124.38720703, 42.50450285]
        //     }
        // }, {
        //     "type": "Feature",
        //     "name": "test",
        //     "id": "1",
        //     "content": "test",
        //     "properties": {
        //         "name": "Coors Field",
        //         "amenity": "Baseball Stadium",
        //         "popupContent": "辽宁省"
        //     },
        //     "geometry": {
        //         "type": "Point",
        //         "coordinates": [124.33227539,40.73893324]
        //     }
        // },{
        //     "type": "Feature",
        //     "name": "test",
        //     "id": "1",
        //     "content": "test",
        //     "properties": {
        //         "name": "Coors Field",
        //         "amenity": "Baseball Stadium",
        //         "popupContent": "辽宁省"
        //     },
        //     "geometry": {
        //         "type": "Point",
        //         "coordinates": [122.17895508,41.28606239]
        //     }
        // }
        // ];
        //
        // L.geoJSON(geojsonFeature, {
        //     onEachFeature: onEachFeature
        // }).addTo(gisMap);

        function changeBaseMap(item) {
            var mapType = item.alt;
            if (mapType == "政区图") {
                if (gisMap.hasLayer(imageLayer)) {
                    gisMap.removeLayer(imageLayer);
                }
                if (!gisMap.hasLayer(normalLayer)) {
                    gisMap.addLayer(normalLayer);
                }
            } else {
                if (gisMap.hasLayer(normalLayer)) {
                    gisMap.removeLayer(normalLayer);
                }
                if (!gisMap.hasLayer(imageLayer)) {
                    gisMap.addLayer(imageLayer);
                }
            }
        }

        //L.marker([41.677142, 123.464918]).addTo(gisMap);
        L.control.zoom({
            zoomInTitle: '放大',
            zoomOutTitle: '缩小',
            position: 'bottomright'
        }).addTo(gisMap);

        $("li.basemap_item").on("click", function (event) {
            changeBaseMap(event.target);
        });
    }

    function drawLayer(layerId, params) {
        var layerConfig = layers[layerId];

        if (params == null) {
            params = {};
            for (let i = 0; i < layerItems.length; i++) {
                for (let j = 0; j < layerItems[i].layers.length; j++) {
                    var item = layerItems[i].layers[j];

                    if (item.id == layerId) {
                        for (let k = 0; k < item.filterGroup.length; k++) {
                            var _filter = item.filterGroup[k];
                            if (_filter.active != -1) {
                                params[_filter.code] = _filter.active;
                            }
                        }
                    } else {
                        continue;
                    }
                }
            }
        }

        var geometryType = 'point';

        if (layerConfig.geometryType != undefined) {
            geometryType = layerConfig.geometryType;
        }

        var layer = new GeoJSONLayer({
            id: layerId,
            title: layerConfig.title,
            url: "/map/layer/getLayerByName?name=" + layerId + "&parms=" + JSON.stringify(params),
            outFields: ["*"],
            renderer: layerConfig.renderer,
            labelingInfo: layerConfig.labelingInfo,
            popupTemplate: layerConfig.popupTemplate,
            geometryType: geometryType
        });
        layerConfig.layer = layer;
        gisMap.add(layer);

        layer.queryFeatures().then(function (results) {
            $("#statis .statis-label").text(layerConfig.title);
            $("#statis .statis-num").text(results.features.length);
            searchFeatures[layerId] = results.features;

        });
    }

    function createLabel(data, _graphics) {
        for (var i = 0; i < data.length; i++) {
            var b = new Graphic({
                attributes: {
                    name: "测试"
                },
                geometry: webMercatorUtils.geographicToWebMercator({
                    type: 'point',
                    x: data[i].lat,
                    y: data[i].lng,
                    spatialReference: new SpatialReference(4326)
                }),
                dom: `<div class="infowindow quality-one" data-code="${data[i].code}" data-type="sz-auto"><div class="window">
                  <span class="regin">${data[i].fj}-${data[i].glc}</span>
				  <div class="title">
					<div>自动</div>
					<div><span class="name">${data[i].name}</span><span class="type">&nbsp;&nbsp;水质等级</span><span class="num" rel="类">Ⅰ</span></div></div>
                  <span class="no">${data[i].code}</span>
                  <span class="time">2021-03-11 08:00</span>
                  <div class="footer"></div></div></div>`,
                grade: "1"
            });
            _graphics.push(b)
        }
    }


    function initLayerDom() {
        var html = "";
        for (var i = 0; i < layerItems.length; i++) {
            var label = "<div class='item'><label class='mui-input-row'>" + layerItems[i].title + "</label>";
            var form = "<form class='mui-input-group layergroup'>";

            for (var j = 0; j < layerItems[i].layers.length; j++) {
                var item = layerItems[i].layers[j];

                var checked = "";
                if (item.checked) {
                    checked = "checked";
                    $(".active-layer").text(item.title);
                }
                form = form +
                    "<div class='mui-input-row mui-checkbox'><label><span class='icon mui-icon iconfont " + item.icon +
                    "' style='color: " + iconColor[j % 4] + ";'></span>" + item.title +
                    "</label> <input value='" + item.id +
                    "' type='checkbox' " + checked + "></div>";

                if (item.filterGroup.length != 0) {

                    $("<li data-layer='" + item.id + "'><a>" + item.title + "</a></li>").appendTo($("#dropdown-menu-nav"));
                    var show = "hide";
                    if (item.checked) {
                        show = "show";
                    }
                    var $tmpHtml = $("<div class='filter-group " + show + "' id='" + item.id +
                        "_filter'></div>");
                    for (var k = 0; k < item.filterGroup.length; k++) {
                        var fgItem = item.filterGroup[k];

                        var $fcDom = $("<div class='filter-group-content'></div>");
                        var $ul = $("<ul></ul>")
                        for (var n = 0; n < fgItem.values.length; n++) {

                            var vItem = fgItem.values[n];
                            var active = "";
                            if (fgItem.active == vItem.value) {
                                active = "active";
                            }

                            $("<li class='filter-item " + active + "' data-value='" +
                                vItem.value + "' data-type='" + fgItem.code + "' data-layer='" + item.id + "'>" + vItem
                                    .text + "</li>").appendTo($ul);
                        }
                        $ul.appendTo($fcDom);
                        $("<div class='filter-group-header'>" + fgItem.name + "</div>").appendTo($tmpHtml);
                        $fcDom.appendTo($tmpHtml);
                    }
                    $tmpHtml.appendTo($(".filter-content"))
                }

            }
            html = html + label + form + "</form></div>"
        }

        $(html).appendTo($("#layerGroup"));
    }


    function parseData(input) {
        const decoder = new TextDecoder('utf8')
        return JSON.parse(decoder.decode(input))
    }

    function toArrayBuffer(input) {
        const encoder = new TextEncoder()
        const view = encoder.encode(input)
        return view.buffer
    }

    initMap();
    initLayerDom();
});

